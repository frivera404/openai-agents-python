// Backend for Vertex AI Agent Builder UI
// Enhanced server with improved error handling, logging, and validation
// To run this server:
// 1. Install dependencies: npm install express cors dotenv @google/genai
// 2. For TypeScript, install dev dependencies: npm install -D @types/express @types/cors ts-node nodemon
// 3. Create a .env.local file in the root directory and add your API key:
//    GEMINI_API_KEY="YOUR_API_KEY_HERE"
// 4. Run the server: npm run dev

import express from 'express';
import type { Request, Response, NextFunction } from 'express';
import cors from 'cors';
import 'dotenv/config';
import { GoogleGenAI, GenerateContentResponse } from "@google/genai";

const app = express();
const port = process.env.PORT || 3001;

// Middleware
app.use(cors({
    origin: process.env.NODE_ENV === 'production' 
        ? ['https://your-domain.com'] 
        : ['http://localhost:5173', 'http://localhost:3000'],
    credentials: true
}));

app.use(express.json({ limit: '10mb' }));

// Request logging middleware
app.use((req: Request, res: Response, next: NextFunction) => {
    console.log(${new Date().toISOString()} -  );
    next();
});

// Global error handler
app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
    console.error('Unhandled error:', err);
    res.status(500).json({ 
        error: 'Internal server error',
        message: process.env.NODE_ENV === 'development' ? err.message : 'Something went wrong'
    });
});

let ai: GoogleGenAI | null = null;

const getGenAI = (): GoogleGenAI => {
    const apiKey = process.env.GEMINI_API_KEY || process.env.API_KEY;
    
    if (!apiKey) {
        throw new Error("GEMINI_API_KEY environment variable not set. Please create a .env.local file with your API key.");
    }
    
    if (!ai) {
        ai = new GoogleGenAI({ apiKey });
        console.log('GoogleGenAI client initialized successfully');
    }
    
    return ai;
};

// Health check endpoint
app.get('/api/health', (req: Request, res: Response) => {
    res.json({ 
        status: 'healthy', 
        timestamp: new Date().toISOString(),
        version: '1.0.0'
    });
});

// Validation middleware for agent launch
const validateAgentLaunchRequest = (req: Request, res: Response, next: NextFunction) => {
    const { model, temperature, systemInstruction, prompt } = req.body;
    
    // Validate required fields
    if (!prompt || typeof prompt !== 'string' || prompt.trim().length === 0) {
        return res.status(400).json({ 
            error: 'Prompt is required and must be a non-empty string.' 
        });
    }
    
    // Validate optional fields
    if (temperature !== undefined) {
        const temp = parseFloat(temperature as string);
        if (isNaN(temp) || temp < 0 || temp > 2) {
            return res.status(400).json({ 
                error: 'Temperature must be a number between 0 and 2.' 
            });
        }
    }
    
    if (model && typeof model !== 'string') {
        return res.status(400).json({ 
            error: 'Model must be a string.' 
        });
    }
    
    if (systemInstruction && typeof systemInstruction !== 'string') {
        return res.status(400).json({ 
            error: 'System instruction must be a string.' 
        });
    }
    
    next();
};

app.post('/api/agent/launch', validateAgentLaunchRequest, async (req: Request, res: Response) => {
    const { model, temperature, systemInstruction, prompt } = req.body;
    
    const startTime = Date.now();
    const requestId = Math.random().toString(36).substring(7);
    
    console.log([] Agent launch request started);
    console.log([] Model: );
    console.log([] Temperature: );
    console.log([] Prompt length:  characters);

    try {
        const genAI = getGenAI();
        
        const requestConfig = {
            model: model || 'models/gemini-robotics-er-1.5-preview',
            contents: prompt,
            config: {
                systemInstruction: systemInstruction || undefined,
                temperature: temperature ? parseFloat(temperature as string) : 0.9,
            },
        };

        console.log([] Sending request to Google GenAI...);
        const response: GenerateContentResponse = await genAI.models.generateContent(requestConfig);
        
        const duration = Date.now() - startTime;
        console.log([] Request completed in ms);
        
        if (!response.text) {
            console.warn([] Empty response received from GenAI);
            return res.status(500).json({ 
                error: 'Empty response received from AI service.' 
            });
        }
        
        console.log([] Response length:  characters);
        
        res.json({ 
            text: response.text,
            metadata: {
                requestId,
                duration,
                model: requestConfig.model,
                temperature: requestConfig.config.temperature
            }
        });

    } catch (error: any) {
        const duration = Date.now() - startTime;
        console.error([] Error after ms:, error);
        
        // Enhanced error handling with specific error types
        if (error.code === 'PERMISSION_DENIED') {
            return res.status(403).json({ 
                error: 'Invalid API key or insufficient permissions.',
                requestId 
            });
        }
        
        if (error.code === 'RESOURCE_EXHAUSTED') {
            return res.status(429).json({ 
                error: 'API quota exceeded. Please try again later.',
                requestId 
            });
        }
        
        if (error.code === 'INVALID_ARGUMENT') {
            return res.status(400).json({ 
                error: 'Invalid request parameters.',
                details: error.message,
                requestId 
            });
        }
        
        // Generic error response
        res.status(500).json({ 
            error: 'Failed to launch agent. Please try again.',
            requestId,
            details: process.env.NODE_ENV === 'development' ? error.message : undefined
        });
    }
});

// Graceful shutdown handling
process.on('SIGTERM', () => {
    console.log('SIGTERM received, shutting down gracefully...');
    process.exit(0);
});

process.on('SIGINT', () => {
    console.log('SIGINT received, shutting down gracefully...');
    process.exit(0);
});

// Start server
const server = app.listen(port, () => {
    console.log(üöÄ Backend server started successfully);
    console.log(üìç Server URL: http://localhost:);
    console.log(üè• Health check: http://localhost:/api/health);
    console.log(ü§ñ Agent API: http://localhost:/api/agent/launch);
    console.log(üåç Environment: );
    
    // Test API key on startup
    try {
        getGenAI();
        console.log('‚úÖ Google GenAI client initialized successfully');
    } catch (error) {
        console.error('‚ùå Failed to initialize Google GenAI client:', (error as Error).message);
        console.error('Please check your GEMINI_API_KEY in .env.local');
    }
});

server.on('error', (error: any) => {
    if (error.code === 'EADDRINUSE') {
        console.error(‚ùå Port  is already in use);
        process.exit(1);
    } else {
        console.error('‚ùå Server error:', error);
        process.exit(1);
    }
});
